/*! map 2016-12-01 */
function mapErrorHandler(){window.alert("Error encountered loading Google Map! Please check code!")}function initMap(){var a={lat:37.792295,lng:-122.052747};map=new google.maps.Map(document.getElementById("map"),{center:a,zoom:10}),oInfoWindow=new google.maps.InfoWindow,loadStations()}function compareStrings(a,b){return a.toLowerCase().includes(b.toLowerCase())}function generateHtmlContent(a,b){var c='<span class="station-title">'+a.name+" Station</span><BR>";c+=a.address+"<BR>",c+=a.city+", "+a.state+" "+a.zip+"<BR><BR>",c+='<div class="rec-banner">API powered by Foursquare</div><BR>',c+='<span class="rec-venue-header">Top 5 Recommended Places (within 1000 meters):</span><BR>';var d=b.length;if(0===d)c+="Still loading ...";else{c+='<table class="venues-table">';for(var e=0;e<d;e++){var f=b[e];c+="<tr>",c+='<td colspan="3" class="venues-title">'+f.name+"</td>",c+="</tr>",c+="<tr>",c+="<td>",c+=void 0!==f.address?f.address:"<i>No address available</i>",c+="</td>",c+="<td>",c+=void 0!==f.phone?f.phone:"<i>No phone available</i>",c+="</td>",c+="<td>",c+=void 0!==f.url?'<a href="'+f.url+'" target="_blank">website</a>':"<i>No website available</i>",c+="</td>",c+="</tr>"}c+="</table>"}return c}function loadStations(){var a=BART_URL+"&key="+BART_KEY,b=[];$.ajax({url:a,dataType:"xml",success:function(a){var c=$(a).find("station"),d=0;$(c).each(function(){var a={};a.name=$(this).find("name").text(),a.lat=$(this).find("gtfs_latitude").text(),a.long=$(this).find("gtfs_longitude").text(),a.address=$(this).find("address").text(),a.city=$(this).find("city").text(),a.county=$(this).find("county").text(),a.state=$(this).find("state").text(),a.zip=$(this).find("zipcode").text(),a.index=d++;var c=new StationItemViewModel(a);b.push(c);var e=FS_URL;e+="ll="+a.lat+","+a.long,e+="&limit="+FS_LIMIT,e+="&radius=1000",e+="&section=topPicks",e+="&client_id="+FS_CLIENT_ID,e+="&client_secret="+FS_CLIENT_SECRET,e+="&v="+FS_VERSION,$.ajax({url:e,success:function(a){for(var b=a.response.groups[0],d=b.items.length,e=[],f=0;f<d;f++){var g=b.items[f].venue,h={};h.name=g.name,h.category=g.categories[0].name,h.address=g.location.address,h.phone=g.contact.formattedPhone,h.lat=g.location.lat,h.lng=g.location.lng,h.url=g.url,e.push(h)}c.recVenues(e);var i="#"+c.name,j=localStorage.favorites;compareStrings(j,i)&&c.markAsFavorite()},error:function(b,c,d){window.alert("Error encountered fetching data for "+a.name+" station. Status code is:"+b.status)}})})},complete:function(){var a=new MapViewModel(b);oRefMapVM=a,ko.applyBindings(a),""!==localStorage.searchTerm&&a.searchTerm(localStorage.searchTerm)},error:function(a,b,c){window.alert("Error encountered fetching stations. Status code:"+a.status)}})}function StationItemViewModel(a){var b=this;b.isFavorite=ko.observable(!1),b.recVenues=ko.observableArray([]),b.name=a.name,b.lat=a.lat,b.long=a.long,b.address=a.address,b.city=a.city,b.state=a.state,b.zip=a.zip,b.index=a.index,b.recVenues.subscribe(function(a){var c=generateHtmlContent(b,a);b.marker().htmlContent=c}),b.hideMarker=function(){b.marker().setVisible(!1)},b.showMarker=function(){b.marker().setVisible(!0)},b.marker=ko.computed(function(){var a={lat:parseFloat(b.lat),lng:parseFloat(b.long)},c=generateHtmlContent(b,[]),d=new google.maps.Marker({position:a,animation:google.maps.Animation.DROP,title:b.name,htmlContent:c});return d.addListener("click",function(){oInfoWindow.setContent(d.htmlContent),oInfoWindow.open(map,d),b.changeColorAndBounceMarker()}),d.setMap(map),d.setVisible(!1),compareStrings(b.name,localStorage.searchTerm)?setTimeout(function(){d.setVisible(!0)},b.index*DELAY_DROP_MS):d.setVisible(!1),d}),b.markAsFavorite=function(){b.isFavorite(!b.isFavorite());var a="#"+b.name,c=localStorage.favorites;b.isFavorite()?(b.showMarker(),b.marker().setIcon(YELLOW_MARKER),compareStrings(c,a)===!1&&(c+=a),localStorage.favorites=c):(localStorage.showMode===SHOW_ALL?b.marker().setIcon(null):(b.marker().setIcon(null),b.hideMarker()),c=c.replace(a,""),localStorage.favorites=c)},b.clickHandler=function(){google.maps.event.trigger(b.marker(),"click")},b.changeColorAndBounceMarker=function(){b.marker().setIcon(GREEN_MARKER),b.marker().setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){b.isFavorite()?b.marker().setIcon(YELLOW_MARKER):b.marker().setIcon(null),b.marker().setAnimation(null)},MARKER_ANIMATION_IN_MS)}}function MapViewModel(a){var b=this;b.isPanelOpen=ko.observable(!1),b.showFavsOnly=ko.observable(!1),b.searchTerm=ko.observable(""),b.items=ko.observableArray(a),b._fulllist=a,b._previtems=b.items(),b.togglePanelHandler=function(){b.isPanelOpen(!b.isPanelOpen()),google.maps.event.trigger(map,"resize")},b.toggleFavHandler=function(){b.showFavsOnly(!b.showFavsOnly()),b.showFavsOnly()?localStorage.showMode=SHOW_FAVS_ONLY:localStorage.showMode=SHOW_ALL,null!==oRefMapVM&&oRefMapVM.showMarkers(localStorage.showMode===SHOW_FAVS_ONLY)},b.items.subscribe(function(a){for(var c,d=b._previtems.length,e=0;e<d;e++)c=b._previtems[e],c.hideMarker();for(d=a.length,e=0;e<d;e++)c=a[e],c.showMarker();b._previtems=a}),b.searchTerm.subscribe(function(c){localStorage.searchTerm=b.searchTerm();for(var d=[],e=0;e<b._fulllist.length;e++){var f=a[e];compareStrings(f.name,b.searchTerm())&&d.push(f)}b.items(d)}),b.clearButtonListener=function(){b.searchTerm("")},b.showMarkers=function(c){for(var d=b._fulllist.length,e=0;e<d;e++){var f=a[e];f.isFavorite()||(c?f.hideMarker():f.showMarker())}}}var BART_URL="http://api.bart.gov/api/stn.aspx?cmd=stns&",BART_KEY="ZI4M-5RS8-9TDT-DWE9",FS_URL="https://api.foursquare.com/v2/venues/explore?",FS_CLIENT_ID="RL4AI1OIKF5CVKPU12OWLL5YWSJ3SSIYZWP4FK2OQZKW0WRF",FS_CLIENT_SECRET="EY4KIAQLBVI0QSZCIZCP35YREJ5WWWPR553EIQOMPF4ZZRSK",FS_LIMIT=5,FS_VERSION="20161101",YELLOW_MARKER="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png",GREEN_MARKER="http://maps.google.com/mapfiles/ms/icons/green-dot.png",DELAY_DROP_MS=75,SHOW_ALL="SHOW ALL",SHOW_FAVS_ONLY="SHOW FAVS ONLY",MARKER_BOUNCE_COUNT=3,MARKER_ANIMATION_IN_MS=700*MARKER_BOUNCE_COUNT,map,markers=[],oRefMapVM=null,oInfoWindow=null;localStorage.searchTerm=localStorage.searchTerm||"",localStorage.favorites=localStorage.favorites||"",localStorage.showMode=localStorage.showMode||SHOW_ALL;