/*! map 2016-11-29 */
function initMap(){var a={lat:37.792295,lng:-122.052747};map=new google.maps.Map(document.getElementById("map"),{center:a,zoom:10}),loadStations()}function compareStrings(a,b){return a.toLowerCase().includes(b.toLowerCase())}function generateHtmlContent(a,b){var c="<span class='station-title'>"+a.name+" Station</span><BR>";c+=a.address+"<BR>",c+=a.city+", "+a.state+" "+a.zip+"<BR><BR>",c+="<span class='rec-venue-header'>Top 5 Recommended Places (within 1000 meters):</span><BR>";var d=b.length;if(0===d)c+="Still loading ...";else{c+="<table class='venues-table'>";for(var e=0;e<d;e++){var f=b[e];c+="<tr>",c+="<td colspan='3' class='venues-title'>"+f.name+"</td>",c+="</tr>",c+="<tr>",c+="<td>",c+=void 0!==f.address?f.address:"<i>No address available</i>",c+="</td>",c+="<td>",c+=void 0!==f.phone?f.phone:"<i>No phone available</i>",c+="</td>",c+="<td>",c+=void 0!==f.url?"<a href='"+f.url+"' target='_blank'>website</a>":"<i>No website available</i>",c+="</td>",c+="</tr>"}c+="</table>"}return c}function loadStations(){var a=BART_URL+"&key="+BART_KEY,b=[];$.ajax({url:a,dataType:"xml",success:function(a){var c=$(a).find("station"),d=0;$(c).each(function(){var a={};a.name=$(this).find("name").text(),a.lat=$(this).find("gtfs_latitude").text(),a.long=$(this).find("gtfs_longitude").text(),a.address=$(this).find("address").text(),a.city=$(this).find("city").text(),a.county=$(this).find("county").text(),a.state=$(this).find("state").text(),a.zip=$(this).find("zipcode").text(),a.index=d++;var c=new StationItemViewModel(a);b.push(c);var e=FS_URL;e+="ll="+a.lat+","+a.long,e+="&limit="+FS_LIMIT,e+="&radius=1000",e+="&section=topPicks",e+="&client_id="+FS_CLIENT_ID,e+="&client_secret="+FS_CLIENT_SECRET,e+="&v="+FS_VERSION,$.ajax({url:e,success:function(a){for(var b=a.response.groups[0],d=b.items.length,e=[],f=0;f<d;f++){var g=b.items[f].venue,h={};h.name=g.name,h.category=g.categories[0].name,h.address=g.location.address,h.phone=g.contact.formattedPhone,h.lat=g.location.lat,h.lng=g.location.lng,h.url=g.url,e.push(h)}c.recVenues(e);var i="#"+c.name,j=localStorage.favorites;compareStrings(j,i)&&c.markAsFavorite()},error:function(a,b,c){console.log("Error encountered fetching data for each station:"+a.status)}})})},complete:function(){var a=new StationListViewModel(b);oRefStationListVM=a,ko.applyBindings(a),""!==localStorage.searchTerm&&a.searchTerm(localStorage.searchTerm)},error:function(a,b,c){console.log("Error encountered fetching stations:"+a.status)}})}function StationItemViewModel(a){var b=this;b.isFavorite=ko.observable(!1),b.recVenues=ko.observableArray([]),b.name=a.name,b.lat=a.lat,b.long=a.long,b.address=a.address,b.city=a.city,b.state=a.state,b.zip=a.zip,b.index=a.index,b.recVenues.subscribe(function(a){var c=generateHtmlContent(b,a);b.marker().htmlContent=c}),b.marker=ko.computed(function(){var a={lat:parseFloat(b.lat),lng:parseFloat(b.long)},c=generateHtmlContent(b,[]),d=new google.maps.Marker({position:a,animation:google.maps.Animation.DROP,title:b.name,htmlContent:c}),e=new google.maps.InfoWindow;return d.addListener("click",function(){e.setContent(d.htmlContent),e.open(map,d)}),compareStrings(b.name,localStorage.searchTerm)?setTimeout(function(){d.setMap(map)},b.index*DELAY_DROP_MS):d.setMap(null),d}),b.markAsFavorite=function(){b.isFavorite(!b.isFavorite());var a="#"+b.name,c=localStorage.favorites;b.isFavorite()?(b.marker().setMap(map),b.marker().setIcon(YELLOW_MARKER),compareStrings(c,a)===!1&&(c+=a),localStorage.favorites=c):(localStorage.showMode===SHOW_ALL?b.marker().setIcon(null):(b.marker().setIcon(null),b.removeMarker()),c=c.replace(a,""),localStorage.favorites=c)},b.setMap=function(a){b.marker().setMap(a)},b.removeMarker=function(){b.setMap(null)},b.addMarker=function(){b.setMap(map)},b.clickHandler=function(){b.marker().setIcon(GREEN_MARKER),b.marker().setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){b.isFavorite()?b.marker().setIcon(YELLOW_MARKER):b.marker().setIcon(null),b.marker().setAnimation(null)},4e3)}}function StationListViewModel(a){var b=this;b.searchTerm=ko.observable(""),b.items=ko.observableArray(a),b._fulllist=a,b._previtems=b.items(),b.items.subscribe(function(a){for(var c=b._previtems.length,d=0;d<c;d++){var e=b._previtems[d];e.removeMarker()}for(c=a.length,d=0;d<c;d++)e=a[d],e.addMarker();b._previtems=a}),b.searchTerm.subscribe(function(c){for(var d=[],e=0;e<b._fulllist.length;e++){var f=a[e];compareStrings(f.name,b.searchTerm())&&d.push(f)}b.items(d)}),b.filterButtonListener=function(){if(localStorage.searchTerm=b.searchTerm(),""===b.searchTerm())b.items(b._fulllist);else{for(var c=[],d=0;d<b._fulllist.length;d++){var e=a[d];compareStrings(e.name,b.searchTerm())&&c.push(e)}b.items(c)}},b.showMarkers=function(c){for(var d=b._fulllist.length,e=0;e<d;e++){var f=a[e];f.isFavorite()||(c?f.removeMarker():f.addMarker())}}}function toggleHandler(){var a=$("#site-wrapper");a.hasClass("show-nav")?a.removeClass("show-nav"):a.addClass("show-nav"),google.maps.event.trigger(map,"resize")}function toggleFavHandler(){var a=$("#toggle-favorites");a.hasClass("show-favs")?(a.removeClass("show-favs"),localStorage.showMode=SHOW_ALL):(a.addClass("show-favs"),localStorage.showMode=SHOW_FAVS_ONLY),oRefStationListVM.showMarkers(localStorage.showMode===SHOW_FAVS_ONLY)}function attachClickHandler(){$("#toggle-panel").on("click",toggleHandler),$("#toggle-favorites").on("click",toggleFavHandler)}var BART_URL="http://api.bart.gov/api/stn.aspx?cmd=stns&",BART_KEY="ZI4M-5RS8-9TDT-DWE9",FS_URL="https://api.foursquare.com/v2/venues/explore?",FS_CLIENT_ID="RL4AI1OIKF5CVKPU12OWLL5YWSJ3SSIYZWP4FK2OQZKW0WRF",FS_CLIENT_SECRET="EY4KIAQLBVI0QSZCIZCP35YREJ5WWWPR553EIQOMPF4ZZRSK",FS_LIMIT=5,FS_VERSION="20161101",YELLOW_MARKER="http://maps.google.com/mapfiles/ms/icons/yellow-dot.png",GREEN_MARKER="http://maps.google.com/mapfiles/ms/icons/green-dot.png",DELAY_DROP_MS=75,SHOW_ALL="SHOW ALL",SHOW_FAVS_ONLY="SHOW FAVS ONLY",map,markers=[],oRefStationListVM=null;localStorage.searchTerm=localStorage.searchTerm||"",localStorage.favorites=localStorage.favorites||"",localStorage.showMode=localStorage.showMode||SHOW_ALL,attachClickHandler();